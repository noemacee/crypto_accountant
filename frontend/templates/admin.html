<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Metrics and API Key Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white shadow-lg rounded-lg p-8 w-full max-w-lg">
      <h1 class="text-2xl font-semibold text-center text-gray-800 mb-6">
        Admin Panel
      </h1>

      <!-- Generate API Key -->
      <h2 class="text-xl font-semibold text-gray-700 mb-4">
        Generate a New API Key
      </h2>
      <form id="generateApiKeyForm" class="space-y-4">
        <div>
          <label for="owner" class="block text-gray-600 font-medium">
            Owner
          </label>
          <input
            type="text"
            id="owner"
            name="owner"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter owner name or identifier"
            required
          />
        </div>
        <button
          type="submit"
          class="w-full bg-green-600 text-white font-medium py-2 px-4 rounded-md shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
        >
          Generate API Key
        </button>
      </form>
      <div id="apiKeyResponse" class="mt-4 text-gray-600"></div>

      <!-- Fetch Metrics -->
      <h2 class="text-xl font-semibold text-gray-700 mt-6">
        View API Usage Metrics
      </h2>
      <form id="metricsForm" class="space-y-4">
        <div>
          <label for="api_key" class="block text-gray-600 font-medium">
            API Key
          </label>
          <input
            type="text"
            id="api_key"
            name="api_key"
            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter API Key"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-blue-600 text-white font-medium py-2 px-4 rounded-md shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          Get Metrics
        </button>
      </form>

      <!-- Admin Button for All Usage Stats -->
      <button
        id="fetchAllMetrics"
        class="w-full mt-4 bg-gray-600 text-white font-medium py-2 px-4 rounded-md shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500"
      >
        View All Metrics (Admin Only)
      </button>

      <!-- Metrics Display -->
      <div id="metricsResponse" class="mt-6">
        <h3 class="text-lg font-semibold text-gray-800">Metrics:</h3>
        <ul
          id="metricsList"
          class="list-disc list-inside text-gray-600 mt-4"
        ></ul>
      </div>
    </div>

    <script>
      // Helper function to render metrics
      function renderMetrics(metrics) {
        const metricsList = document.getElementById("metricsList");
        metricsList.innerHTML = "";
        metrics.forEach((metric) => {
          const listItem = document.createElement("li");
          listItem.textContent = `API Key: ${
            metric.api_key || "N/A"
          }, Endpoint: ${metric.endpoint}, Count: ${metric.count}`;
          metricsList.appendChild(listItem);
        });
      }

      // Generate API Key Logic
      const generateApiKeyForm = document.getElementById("generateApiKeyForm");
      const apiKeyResponseDiv = document.getElementById("apiKeyResponse");

      generateApiKeyForm.addEventListener("submit", async (event) => {
        event.preventDefault();

        const owner = document.getElementById("owner").value.trim();

        if (!owner) {
          apiKeyResponseDiv.innerHTML =
            '<p class="text-red-600">Owner is required to generate an API key.</p>';
          return;
        }

        try {
          const response = await fetch("/generate_api_key", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ owner }),
          });

          const result = await response.json();

          if (response.ok) {
            apiKeyResponseDiv.innerHTML = `<p class="text-green-600">API Key Generated: ${result.api_key}</p>`;
          } else {
            apiKeyResponseDiv.innerHTML = `<p class="text-red-600">${
              result.error || "Failed to generate API key."
            }</p>`;
          }
        } catch (error) {
          console.error("Error generating API key:", error);
          apiKeyResponseDiv.innerHTML =
            '<p class="text-red-600">An error occurred. Please try again.</p>';
        }
      });

      // Fetch metrics for a specific API key
      const metricsForm = document.getElementById("metricsForm");
      metricsForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const apiKey = document.getElementById("api_key").value.trim();

        if (!apiKey) {
          document.getElementById(
            "metricsResponse"
          ).innerHTML = `<p class="text-red-600">API Key is required to fetch metrics.</p>`;
          return;
        }

        try {
          const response = await fetch("/usage_stats", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-Key": apiKey,
            },
            body: JSON.stringify({}),
          });

          const result = await response.json();

          if (response.ok) {
            renderMetrics(result.usage || []);
          } else {
            document.getElementById(
              "metricsResponse"
            ).innerHTML = `<p class="text-red-600">${
              result.error || "Failed to fetch metrics."
            }</p>`;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "metricsResponse"
          ).innerHTML = `<p class="text-red-600">An error occurred. Please try again.</p>`;
        }
      });

      // Fetch all metrics (admin-only functionality)
      const fetchAllMetricsButton = document.getElementById("fetchAllMetrics");
      fetchAllMetricsButton.addEventListener("click", async () => {
        try {
          const response = await fetch(`/all_usage_stats`);
          const result = await response.json();

          if (response.ok) {
            renderMetrics(result.usage || []);
          } else {
            document.getElementById(
              "metricsResponse"
            ).innerHTML = `<p class="text-red-600">${
              result.error || "Failed to fetch all metrics."
            }</p>`;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById(
            "metricsResponse"
          ).innerHTML = `<p class="text-red-600">An error occurred. Please try again.</p>`;
        }
      });
    </script>
  </body>
</html>
